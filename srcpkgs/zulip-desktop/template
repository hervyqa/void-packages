# Template file for 'zulip-desktop'
pkgname=zulip-desktop
version=5.10.3
revision=1
_electronver=24.3.0
_npmver=9.5.1
hostmakedepends="nodejs python3"
makedepends="GConf-devel electron24 libxkbfile-devel libXtst-devel"
depends="electron24 gtk+3 nss"
short_desc="Workplace chat that improves your productivity"
maintainer="Luca - <luca.andrea.fuse@gmx.com>"
license="Apache-2.0"
homepage="https://www.zulip.com"
distfiles="https://github.com/zulip/zulip-desktop/archive/refs/tags/v${version}.tar.gz"
checksum=0ac9a029943030c21c8f77b09c48d49d0bd9823532577bee17d83ebf0fbbd177

do_configure() {
	npm ci
}

do_build() {
	npm install -g npm@${_npmver}
	npm run pack

	/usr/lib/node_modules/npm/bin/node-gyp-bin/node-gyp install \
	--target=$_electronver \
	--tarball=/usr/include/electron${_electronver%%.*}/node_headers.tar.gz
}

do_install() {
	cat > zulip <<-EOF
	#!/bin/sh
	exec electron${_electronver%%.*} /usr/lib/zulip-desktop/app.asar "\$@"
	EOF
	vbin zulip

	vinstall "dist/linux-unpacked/resources/app.asar" 644 /usr/lib/zulip-desktop
	vinstall ${FILESDIR}/zulip.desktop 0644 usr/share/applications

	for i in 16 24 32 48 64 128 256 512 1024 ; do
		vinstall build/icons/${i}x${i}.png 644 usr/share/icons/hicolor/${i}x${i}/apps zulip.png
	done
}
